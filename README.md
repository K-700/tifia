# Тестовое задание для Tifia.com

## Вводная информация
В нашем сервисе клиенты представлены в таблице Users. Каждый клиент может открыть до 12 счетов. Счета хранятся в таблице Accounts, каждый счёт связан с определенным клиентом. На любом из счетов может быть торговля. Торговые операции представлены в таблице Trades.

Очень часто нам приходится строить дерево партнера, опираясь на поле partner_id в таблице Users. Под партнерским деревом понимается структура, в вершине которой находится заданный клиент. Под ним находятся другие клиенты, у которых User2[partner_id] = User1[client_uid], у User2 могут быть еще рефералы (те, у кого в partner_id стоит User2[client_uid]). Если partner_id = 0, это означает, что клиент не входит ни в чью реферальную сетку, но может быть корнем своей сети.

## Задачи
+ Проанализировать базу данных, указать узкие места.
+ Построить дерево рефералов на основе поля partner_id таблицы Users
+ Написать скрипт, способный обсчитать реферальную сетку партнера по следующим критериям:
    + посчитать суммарный объем volume * coeff_h * coeff_cr по всем уровням реферральной системы за период времени
    + посчитать прибыльность (сумма profit) за определенный период времени
    + посчитать количество прямых рефералов и количество всех рефералов клиента
        + [под прямыми рефералами понимаются те, у кого в partner_id стоит client_uid клиента]
        + [под всеми рефералами понимается совокупность всех прямых рефералов, их прямых рефералов и т.д. до клиентов, под которыми нет рефералов]
    + посчитать количество уровней реферальной сетки
    + при выполнении задания нужно использовать фреймворк Yii2
    
Примечание: период времени определяет интервал поля close_time таблицы Trades

Для удобства, можно обсчитать клиента с client_uid = 82824897

## Анализ базы данных
+ Отсутсвтие индексов/внешних ключей
+ Нарушение 3NF (например, атрибуты id -> country являются транзитивно зависимыми)
+ Для gender лучше использовать ENUM, status привести к tinyint(1)

## Запуск  
`php yii referral/get-data 82824897` - обсчитать клиента с id = 82824897 

## Пояснения к решению
В 1 очередь, была цель сделать больше производительное, чем красивое решение, поэтому все дерево вытягивается в 1 запрос, кладется в кеш и обрабатывается на стороне PHP, минимизируя количество запросов к БД (по этой же причине profit и volume высчитываются в 1 запрос). Если честно, сил на потестить и PHPDoc уже не осталось, но вроде должно быть верно и в целом идея понятна :). Буду рада развернутому фидбеку по решению, если будет возможность.
  